#!/usr/bin/env python3

import numpy as np
import rospy
from sensor_msgs.msg import Image, LaserScan, CameraInfo
from cv_bridge import CvBridge
import cv2

# ---------------------------------------------------
#   Parameters
# ---------------------------------------------------

# Masks - Color ranges
# TODO Verificar valores
# Red color

lower_red = np.array([0, 0, 90])
upper_red = np.array([40, 40, 256])

# Green color
lower_green = np.array([0, 90, 0])
upper_green = np.array([40, 256, 40])

# Blue color
lower_blue = np.array([90, 0, 0])
upper_blue = np.array([256, 40, 40])


class Driver:
    def __init__(self):
        # Get team, hunter and prey
        self.allplayers = {'red': rospy.get_param('/red_players'),
                           'green': rospy.get_param('/green_players'),
                           'blue': rospy.get_param('/blue_players')}
        self.player = rospy.get_name().strip('/')
        if self.player in self.allplayers['red']:
            self.team = 'red'
            self.hunter = 'blue'
            self.prey = 'green'
        elif self.player in self.allplayers['green']:
            self.team = 'green'
            self.hunter = 'red'
            self.prey = 'blue'
        elif self.player in self.allplayers['blue']:
            self.team = 'blue'
            self.hunter = 'green'
            self.prey = 'red'
        else:
            self.team = 'Alone'
            self.hunter = 'No one'
            self.prey = 'No one'

        # Topics to subscribe
        topic_camera = "/" + self.player + '/camera/rgb/image_raw'
        topic_backcamera = "/" + self.player + '/back_camera/rgb/image_raw'
        topic_laser = "/" + self.player + '/scan'
        # Topics subscription
        # self.subscriber_laser = rospy.Subscriber(topic_laser, LaserScan, self.getLaserCallback)
        self.subscriber_camera = rospy.Subscriber(topic_camera, Image, self.getCameraCallback)
        # self.subscriber_backcamera = rospy.Subscriber(topic_backcamera, Image, self.getBackCameraCallback)

    def getCameraCallback(self, image_message):
        bridge = CvBridge()
        cv_image = bridge.imgmsg_to_cv2(image_message, desired_encoding='passthrough')


    # def laser_to_camera(self, camera, laser_points):
    #     laser_points_cameraframe = []

    def team_identification_callback(self):
        return self.player, self.team, self.hunter, self.prey


def main():
    topic = 'chatter'
    rospy.init_node('p_g3_driver', anonymous=False)
    # Testing

    rospy.loginfo("I'm " + Driver().player + ", from team " + Driver().team +
                  "\nI want to catch " + Driver().prey + " but I fear " + Driver().hunter)
    rospy.spin()


if __name__ == '__main__':
    try:
        main()
    except rospy.ROSInterruptException:
        pass
